学习理解一致性哈希算法的使用。

# 1 设计一个分布式 key value 存储系统

假设我们需要设计一个分布式 key value 存储系统，这个系统对外暴露两个接口：

- 写。将一个 key value 写到系统里面
- 读。根据 key 获得 value 的值

假设我这个系统有 5 个节点，这 5 个节点组成一个集群提供服务，理想情况下，系统的 key value 都平均分布在这 5 个节点中，当客户端需要读写一个 key value 对时，需要根据 key 去计算应该访问哪台机器，具体实现则是先计算 key 的哈希值，然后根据哈希值计算出需要放到哪个节点。

```java
    set(String key, List<Node> nodes) {
        // 通过文件路径计算哈希值
        int hash = hash(key);

        // 找到需要上传的节点
        int index = hash % nodes.size();
        Node node = nodes.get(index);


        node.set(key);
    }
```
假设后期我们需要进行横向扩展，加了 2 个节点，此时系统中由原来的 5 个节点变成了 7 个节点，这就意味着原来所有节点的数据需要重新进行哈希计算来适配新的容量，也就意味着需要进行大量的数据迁移，每次扩容都要进行大量的数据迁移，这是非常麻烦的，一致性哈希算法就是为了解决这个问题而出现的。

# 2 一致性哈希

上面提到的痛点在于，数据在节点之间的分布和哈希函数是强相关的，只要哈希函数发生一点变化，数据在节点之间的分布就要重新计算。一致性哈希的主要思想就是减少哈希函数和数据分布之间的相关性，当哈希函数发生变化时，只需要将少量的数据重新迁移。

首先将哈希空间设置成一个固定且大的值，在上面提到的 5 个节点的情况下，哈希空间是 5 ，假设我们把哈希空间设置成 16384 个，然后将这些空间平均分配给这 5 个节点，可以将这个空间想象成一个圆环，假设哈希计算出的空间值是 100，则分配到节点 1，如果哈希计算出的空间值是 4000，则分配到节点 2 ......

# 2.1 增加一个节点

假如增加一个节点，只需要把该节点到上一个节点之间的数据迁移到新增加的节点上，不会影响其它数据

# 2.2 删除一个节点

同理，删除一个节点，只需要把该节点的数据迁移到下一个节点即可

